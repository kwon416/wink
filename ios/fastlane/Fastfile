# frozen_string_literal: true

default_platform(:ios)

platform :ios do
  def updateVersion(options)
    if options[:version]
      version = options[:version]
    else
      version = prompt(text: "Enter the version type or specific version\n(major, minor, patch or 1.0.0): ")
    end

    re = /\d+.\d+.\d+/
    versionNum = version[re, 0]

    if versionNum
      increment_version_number(
        version_number: versionNum
      )
    elsif version == 'major' || version == 'minor' || version == 'patch'
      increment_version_number(
        bump_type: version
      )
    else
      UI.user_error!('[ERROR] Wrong version!!!!!!')
    end
  end

  def certificate(options)
    if options[:type] == 'github'
      create_keychain(
        name: 'fastlane_ios_app_keychain',
        password: ENV['KEYCHAIN_PASSWORD'],
        timeout: 1800,
        default_keychain: true,
        unlock: true,
        lock_when_sleeps: false
      )
      import_certificate(
        certificate_path: 'distribution.p12',
        certificate_password: ENV['CERTIFICATE_PASSWORD'],
        keychain_name: 'fastlane_ios_app_keychain',
        keychain_password: ENV['KEYCHAIN_PASSWORD']
      )
    end
    install_provisioning_profile(path: ENV['PROVISIONING_PROFILE_PATH'])
    update_project_provisioning(
      xcodeproj: 'Runner.xcodeproj',
      profile: ENV['PROVISIONING_PROFILE_PATH'],
      build_configuration: 'Release'
    )
    api_key = app_store_connect_api_key(
      key_id: ENV['APPSTORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APPSTORE_CONNECT_API_KEY_ISSUER_ID'],
      key_filepath: ENV['AUTH_KEYFILE_PATH'],
    )
    api_key
  end

  # Flutter build ios
  lane :flutter_build_ios do
#     sh("cd", "..")

    sh("flutter", "clean")

    sh("flutter", "build", "ios")
  end

  # Send slack message
  lane :send_slack_message do |options|
    version = get_version_number(xcodeproj: "Runner.xcodeproj")
    build_number = get_build_number(xcodeproj: "Runner.xcodeproj")
    slack(
      message: options[:msg],
      payload: {
        "Version" => :version, # ì‹¬ë³¼
        "Build" => build_number,
        "Environment" => "#{ENV['ENV_EMOJI']} #{ENV['ENV']}"
      },
    )
  end

  lane :install_plugin do

  end

  # Add badge to app icon
  private_lane :add_badge_to_icon do
    if ENV["ENV"] == "STAGING"
      add_badge(alpha: true, dark:true)
    end
  end

  desc 'Update version'
  lane :version do |options|
    updateVersion(options)
    increment_build_number(xcodeproj: 'Runner.xcodeproj')
  end

  desc 'Running iOS tests'
    lane :tests do
      run_tests()
    end

  desc 'Submit review only'
  lane :submit_review do |_options|
    upload_to_app_store(
      submit_for_review: true,
      automatic_release: true,
      force: true,
      skip_metadata: true,
      skip_screenshots: true,
      skip_binary_upload: true
    )
  end

  desc 'Push a new beta build to TestFlight'
  lane :beta do |options|
    install_plugin
    # Fetching the latest build number from TestFlight
    increment_build_number(
      build_number: latest_testflight_build_number + 1,
      xcodeproj: "Runner.xcodeproj"
    )

    # ë°°í¬ ì‹œì‘ ì‹œ ìŠ¬ë™ ë©”ì„¸ì§€ ë³´ë‚´ê¸°
    #send_slack_message(msg: "ğŸ’« TestFlight ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.")

    # í™˜ê²½ ë³„ ë¹Œë“œ
    flutter_build_ios

    # Add badge to app icon (only testbed)
    add_badge_to_icon
    if options[:type] == 'github'
      api_key = certificate(options)
    else
      get_certificates
      get_provisioning_profile
    end

    build_app(
      workspace: "Runner.xcworkspace",
      configuration: "Release",
      clean: true,
      silent: true,
      scheme: 'Runner',
      xcargs: '-allowProvisioningUpdates'
    )

    upload_to_testflight(
      uses_non_exempt_encryption: false,
#       skip_submission: true # ì—…ë¡œë“œ í›„ ë°°í¬í• ì§€
#     api_key: api_key
    )


    # Send slack message
#     send_slack_message(msg: "ğŸš€ Successfully distributed a new beta build âœ¨")
  end

  desc 'Push a new release build to the App Store'
  lane :release do |options|
    api_key = certificate(options)
    build_app(
      workspace: 'Runner.xcworkspace',
      scheme: 'Runner',
    )
    upload_to_app_store(
      force: true, # Fastlaneê°€ ìƒì„±í•˜ëŠ” HTML reportë¥¼ ìƒì„±í•˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.
      reject_if_possible: true, # ì‹¬ì‚¬ ëŒ€ê¸°ì¤‘ì¸ ë²„ì „ì´ ìˆë‹¤ë©´ ì·¨ì†Œí•©ë‹ˆë‹¤
      skip_metadata: false, # ì•± ìŠ¤í† ì–´ì˜ ì •ë³´ë¥¼ ë“±ë¡í• ì§€ ê²°ì •í•©ë‹ˆë‹¤. ë²„ì „ ìˆ˜ì • ë‚´ìš©ì„ ì‘ì„±í•´ì•¼ í•˜ë¯€ë¡œ ìŠ¤í‚µí•˜ë©´ ì•ˆë¨.
      skip_screenshots: true, # ìë™ ë°°í¬ ì‹œ ì´ë¯¸ì§€ ë“±ë¡ ìŠ¤í‚µ
      languages: ['en-US', 'ja','ko'], # ì•± ì§€ì—­í™”
      release_notes: {        # ì‘ì„± í•„ìš”
        "default" => "bug fixed",
        "en-US" => "bug fixed",
        "ja" => "ãƒã‚°ä¿®æ­£",
        "ko" => "ë²„ê·¸ ìˆ˜ì •"
      },
      submit_for_review: true, # ì•± ì‹¬ì‚¬ ì œì¶œ
      precheck_include_in_app_purchases: false,
      automatic_release: true, # ì‹¬ì‚¬ í›„ ìŠ¤í† ì–´ì— ìë™ ë°°í¬
      submission_information: { # ë°°í¬ ì „ ì•”í˜¸í™” ê´‘ê³  í¬í•¨ ì—¬ë¶€ ì˜µì…˜
        add_id_info_uses_idfa: false,
        export_compliance_encryption_updated: false,
        export_compliance_uses_encryption: false
      },
      api_key: api_key
    )
  end
end